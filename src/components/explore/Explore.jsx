import React, { useEffect, useState } from "react";
import  {client}  from "../../sanityClient";
import  {writeClient}  from "../../sanityClient";

import "./Explore.css";
import { Link } from "react-router-dom";

const Explore = () => {
  const [posts, setPosts] = useState([]); // Inl√§gg
  const [selectedCategory, setSelectedCategory] = useState(null); // Vald kategori
  const [genres, setGenres] = useState([]); // Valda genrer
  const [selectedGenres, setSelectedGenres] = useState([]);  // Valda genrer
  const [searchTerm, setSearchTerm] = useState(''); // S√∂kf√§lt
  const [showGenres, setShowGenres] = useState(false);  // Filtrering boxen



  const categories = [
    { title: "üéÆ Spel", slug: "spel" },
    { title: "üé¨ Film", slug: "film" },
    { title: "üéµ Musik", slug: "musik" },
    { title: "üìö B√∂cker", slug: "bocker" },
  ];
  // H√§mtar alla inl√§gg
  const fetchAllPosts = async () => {
    const query = `*[_type == "post"]{
      _id,
      title,
      slug,
      year,
      producer,
      category->{title, slug},
      genres[]->{title},
      body,
      likes,
      dislikes
    }`;
    const result = await client.fetch(query);
    setPosts(result);
  };
  // H√§mtar inl√§gg baserat p√• vald kategori
  const fetchPostsByCategory = async (slug) => {
    const query = `
      *[_type == "post" && category->slug.current == $slug]{
        _id,
        title,
        slug,
        year,
        producer,
        category->{title, slug},
        genres[]->{title},
        body,
        likes,
        dislikes
      }
    `;
    const result = await client.fetch(query, { slug });
    setPosts(result);
  };
  // H√§mtar genrer f√∂r en vald kategori
  const fetchGenresByCategory = async (slug) => {
    const query = `
      *[_type == "genre" && category->slug.current == $slug]{
        _id,
        title
      }
    `;
    const result = await client.fetch(query, { slug });
    setGenres(result);
  };
  // H√§mtar genrer f√∂r en vald kategori
  const handleGenreChange = async (e, genreTitle) => {
    const checked = e.target.checked;
    let updatedGenres;

    if (checked) {
      updatedGenres = [...selectedGenres, genreTitle];
    } else {
      updatedGenres = selectedGenres.filter((g) => g !== genreTitle);
    }

    setSelectedGenres(updatedGenres);

    // Om ingen genre √§r vald, h√§mta bara kategori-filter (utan genrefilter)
    if (updatedGenres.length === 0) {
      fetchPostsByCategory(selectedCategory);
      return;
    }

    // Filtrera p√• b√•de kategori och genre
    const query = `
    *[_type == "post" && category->slug.current == $slug && count(genres[@->title in $genreTitles]) > 0]{
      _id,
      title,
      slug,
      year,
      producer,
      category->{title, slug},
      genres[]->{title},
      body,
      likes,
      dislikes
    }
  `;

    const result = await client.fetch(query, {
      slug: selectedCategory,
      genreTitles: updatedGenres,
    });

    setPosts(result);
  };

 // S√∂kfunktion, vi kollar s√∂kf√§ltet och ser om vi hittar en match i titlar, producenter eller inneh√•ll
  const handleSearch = async () => {
  if (!searchTerm.trim()) return;

  const term = searchTerm.toLowerCase(); // L√§gger till tolowercase f√∂r att s√∂ka oavsett versaler

  const query = `
    *[_type == "post" && (
      title match $term ||
      producer match $term ||
      pt::text(body) match $term
    )]{
      _id,
      title,
      year,
      producer,
      category->{title, slug},
      genres[]->{title},
      body,
      likes,
      dislikes
    }
  `;
  const result = await client.fetch(query, { term: `*${term}*` });
  setPosts(result);
};

const handleLike = async (postId) => {
  await writeClient // Anv√§der oss avb writeClient d√§r vi kan g√∂ra en post till sanity
    .patch(postId)
    .setIfMissing({ likes: 0 })
    .inc({ likes: 1 })
    .commit() // commitar √§ndringen till Sanity
    .then(() => {
      // Uppdaterar lokalt state f√∂r att reflektera √§ndringen
      setPosts(prev =>
        prev.map(post => post._id === postId ? { ...post, likes: (post.likes || 0) + 1 } : post)
      );
    });
};
 // Hanterar ogillade inl√§gg och uppdeterar antalet samt visar det
const handleDislike = async (postId) => {
  await writeClient
    .patch(postId)
    .setIfMissing({ dislikes: 0 })
    .inc({ dislikes: 1 })
    .commit()
    .then(() => {
      setPosts(prev =>
        prev.map(post => post._id === postId ? { ...post, dislikes: (post.dislikes || 0) + 1 } : post)
      );
    });
    
};
// H√§mtar de 10 mest gillade inl√§ggen
// Vi m√•ste g√∂ra en ny fetch f√∂r att h√§mta de mest gillade inl√§ggen
// samma sak f√∂r minst gillade
const fetchMostLiked = async () => {
  const query = `*[_type == "post"] | order(coalesce(likes, 0) desc)[0...10] {
    _id, title,slug,
    likes,dislikes,
    year, producer,category->{title},
    genres[]->{title},
    body
  }`;
  const result = await client.fetch(query);
  setPosts(result);
};
 // H√§mtar de 10 mest ogillade inl√§ggen
const fetchLeastLiked = async () => {
  const query = `*[_type == "post"] | order(coalesce(dislikes, 0) desc)[0...10] {
    _id, title,slug,likes,dislikes,year,producer,category->{title},
    genres[]->{title},
    body
  }`;
  const result = await client.fetch(query);
  setPosts(result);
};



  const handleCategoryClick = async (slug) => {
    // Om man klickar p√• samma kategori igen -> nollst√§ll
    if (selectedCategory === slug) {
      setSelectedCategory(null);
      setGenres([]);
      setSelectedGenres([]);
      fetchAllPosts();
      return;
    }
    // Nollst√§ll genrer och kategori om man klickar p√• dem igen
    setSelectedCategory(slug);
    setSelectedGenres([]);
    await fetchGenresByCategory(slug);
    await fetchPostsByCategory(slug);
  };

  useEffect(() => {
    fetchAllPosts();
  }, []);

  return (
    <main className="explore">
      <header className="explore-header">
        <section className="search-section">
          <h1>Uppt√§ck senaste inl√§ggen</h1>
          <input
              type="text"
              placeholder="S√∂k..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <button onClick={handleSearch}>S√∂k</button>
        </section>
      </header>

      <section className="category-buttons">
        {categories.map((cat) => (
          <button
            key={cat.slug}
            className={`category-btn ${
              selectedCategory === cat.slug ? "active" : ""
            }`}
            onClick={() => handleCategoryClick(cat.slug)}
          >
            {cat.title}
          </button>
        ))}
      </section>

     <section className="filter-section">
  <h2 onClick={() => setShowGenres(!showGenres)}>
    Filtrera {showGenres ? "‚ñ≤" : "‚ñº"}
  </h2>
  <section className={`genre-filters ${showGenres ? "open" : ""}`}>
    {genres.length === 0 ? (
      <p>Inga genrer tillg√§ngliga</p>
    ) : (
      genres.map((genre) => (
        <label key={genre._id}>
          <input
            type="checkbox"
            onChange={(e) => handleGenreChange(e, genre.title)}
            checked={selectedGenres.includes(genre.title)}
          />
          {genre.title}
        </label>
      ))
    )}
  </section>
</section>


      <section className="posts-section">
        <section className="filter-likes">
  <button onClick={fetchMostLiked}>Mest gillade</button>
  <button onClick={fetchLeastLiked}>Minst gillade</button>
</section>
   <h2>Inl√§gg</h2>
     {posts.length === 0 ? (
      <p>Inga inl√§gg √§nnu.</p>
       ) : (
      posts.map((post) => (
      <article key={post._id} className="post-card">
        <section className="post-info">
          {post.slug?.current ? (
            <Link to={`/post/${post.slug.current}`}>
              <h3>{post.title}</h3> </Link>
                  ) : (
                  <h3>{post.title}</h3>)}
                <p>√Ör: {post.year}</p>
                <p>Producent: {post.producer}</p>
                <p>Kategori: {post.category?.title}</p>
                <p>Genrer: {post.genres?.map((g) => g.title).join(", ")}</p>
                <p>Inneh√•ll: {post.body}</p>
              </section>
              <section className="post-actions">
                <button onClick={() => handleLike(post._id)}>üëç {post.likes || 0}</button>
                <button onClick={() => handleDislike(post._id)}>üëé {post.dislikes || 0}</button>
              </section>
            </article>
          ))
        )}
      </section>
    </main>
  );
};

export default Explore;
